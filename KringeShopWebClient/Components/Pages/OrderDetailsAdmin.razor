@page "/OrderDetails/{OrderId:int}"
@rendermode InteractiveServer

@using KringeShopLib.Model;
@using KringeShopWebClient.Services;

@inject AdminService adminService;
@inject NavigationManager nav;

<AuthorizeView Roles="admin"> 
    <Authorized>
        @if (order != null)
        {
            <div>
                <h5>Заказ #@order.Id</h5>
                <p><strong>Адрес:</strong> @order.Adress</p>
                <p><strong>Полная стоимость:</strong> @order.FullCost.ToString("C")</p>
                <p><strong>Дата получения:</strong> @order.RecieveDate?.ToString("d")</p>
                <p><strong>Статус:</strong> @order.Status</p>
                <p><strong>Дата создания:</strong> @order.CreateDate?.ToString("d")</p>
                <p><strong>Самовывоз:</strong> @(order.IsSelfPickUp ? "Да" : "Нет")</p>

                <h5>Товары в заказе:</h5>
                <ul>
                    @if (orderItems != null)
                    {
                        foreach (var item in orderItems)
                        {
                            <li>
                                <div>
                                    <label>Товар#@item.ProductId @item.ProductName - @item.Count шт. - @item.Cost.ToString("C")</label>
                                    <button @onclick="()=>GoToProductDetails(item.ProductId)"><i>...</i></button>
                                </div>
                            </li>
                        }
                    }
                </ul>

                <h5>Контактные данные:</h5>
                @if (user != null)
                {
                    <label><strong>Имя пользователя</strong></label>
                    <p>@user.Username</p>

                    <label><strong>Почта</strong></label>
                    <p>@user.Email</p>

                    <label><strong>Телефон</strong></label>
                    <p>@user.ContactPhone</p>
                }

            </div>
        }
    </Authorized>
</AuthorizeView>

@code {
    [Parameter]
    public int OrderId{ get; set; }
    private OrderDTO order;
    private UserDTO user;
    private List<OrderItemDTO> orderItems;

    [CascadingParameter]
    private Task<AuthenticationState> authenticationState { get; set; }

    protected override Task OnInitializedAsync() => LoadData();

    private async Task LoadData()
    {
        var auth = await authenticationState;
        order = await adminService.GetOrder(OrderId, auth.User.FindFirst("Token")?.Value);
        if(order!=null)
        {
            orderItems = await adminService.GetOrderItems(OrderId);
            user = await adminService.GetUserData(order.UserId);
        }
    }

    private void GoToProductDetails(int product_id)
    {
        nav.NavigateTo($"/Product/{product_id}");
    }

    private async void UpdateOrder()
    {
        
    }
}
